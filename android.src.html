<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>install.cat - Downloading APK...</title>
  <meta name="theme-color" content="#0d1117" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üê±</text></svg>">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #ffffff;
      --bg-secondary: #f6f8fa;
      --text: #1f2328;
      --text-secondary: #656d76;
      --accent: #8957e5;
      --accent-hover: #7c3aed;
      --border: #d0d7de;
      --code-bg: #f6f8fa;
      --success: #2da44e;
      --error: #cf222e;
      --font-sans: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0d1117;
        --bg-secondary: #161b22;
        --text: #e6edf3;
        --text-secondary: #8b949e;
        --accent: #a371f7;
        --accent-hover: #8957e5;
        --border: #30363d;
        --code-bg: #161b22;
        --success: #3fb950;
        --error: #f85149;
      }
    }

    body {
      font-family: var(--font-sans);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container {
      text-align: center;
      padding: 2rem;
      max-width: 480px;
    }

    /* Spinner */
    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 1.5rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .logo {
      font-size: 2rem;
      margin-bottom: 1.5rem;
    }

    .message {
      font-size: 1.1rem;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    /* Error state */
    .error-state { display: none; }

    .error-state.visible {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    .loading-state.hidden { display: none; }

    .error-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .error-title {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      color: var(--error);
    }

    .error-detail {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 1.5rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      background: var(--accent);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1rem;
      transition: background 0.2s;
    }

    .btn:hover { background: var(--accent-hover); }

    .home-link {
      display: block;
      margin-top: 1.5rem;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 0.875rem;
    }

    .home-link:hover { color: var(--accent); }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Loading state -->
    <div class="loading-state" id="loading">
      <div class="logo">üê±</div>
      <div class="spinner"></div>
      <p class="message" data-i18n="androidLoading">Detecting your device and downloading...</p>
    </div>

    <!-- Error state -->
    <div class="error-state" id="error">
      <div class="error-icon">üì¶</div>
      <p class="error-title" data-i18n="androidError">No Android app found for this project</p>
      <p class="error-detail" id="error-detail"></p>
      <a class="btn" id="releases-link" href="#" data-i18n="androidViewReleases">View all releases</a>
      <a class="home-link" href="/">üê± install.cat</a>
    </div>
  </div>

  <script>
    const translations = {
      en: { androidLoading: 'Detecting your device and downloading...', androidError: 'No Android app found for this project', androidViewReleases: 'View all releases' },
      pt: { androidLoading: 'Detectando seu dispositivo e baixando...', androidError: 'Nenhum app Android encontrado para este projeto', androidViewReleases: 'Ver todas as releases' },
      ca: { androidLoading: 'Detectant el teu dispositiu i baixant...', androidError: "No s'ha trobat cap app Android per a aquest projecte", androidViewReleases: 'Veure totes les releases' },
      ar: { androidLoading: 'ÿ¨ÿßÿ±Ÿä ÿßŸÉÿ™ÿ¥ÿßŸÅ ÿ¨Ÿáÿßÿ≤ŸÉ ŸàÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...', androidError: 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ™ÿ∑ÿ®ŸäŸÇ Android ŸÑŸáÿ∞ÿß ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ', androidViewReleases: 'ÿπÿ±ÿ∂ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ÿµÿØÿßÿ±ÿßÿ™' },
      bn: { androidLoading: '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏ ‡¶∂‡¶®‡¶æ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶è‡¶¨‡¶Ç ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...', androidError: '‡¶è‡¶á ‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã Android ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø', androidViewReleases: '‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶∞‡¶ø‡¶≤‡¶ø‡¶ú ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®' },
      de: { androidLoading: 'Ger√§t wird erkannt und Download l√§uft...', androidError: 'Keine Android-App f√ºr dieses Projekt gefunden', androidViewReleases: 'Alle Releases anzeigen' },
      es: { androidLoading: 'Detectando tu dispositivo y descargando...', androidError: 'No se encontr√≥ app Android para este proyecto', androidViewReleases: 'Ver todas las releases' },
      fr: { androidLoading: 'D√©tection de votre appareil et t√©l√©chargement...', androidError: 'Aucune app Android trouv√©e pour ce projet', androidViewReleases: 'Voir toutes les releases' },
      hi: { androidLoading: '‡§Ü‡§™‡§ï‡§æ ‡§°‡§ø‡§µ‡§æ‡§á‡§∏ ‡§™‡§π‡§ö‡§æ‡§®‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à ‡§î‡§∞ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...', androidError: '‡§á‡§∏ ‡§™‡•ç‡§∞‡•ã‡§ú‡•á‡§ï‡•ç‡§ü ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à Android ‡§ê‡§™ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ', androidViewReleases: '‡§∏‡§≠‡•Ä ‡§∞‡§ø‡§≤‡•Ä‡§ú‡§º ‡§¶‡•á‡§ñ‡•á‡§Ç' },
      id: { androidLoading: 'Mendeteksi perangkat Anda dan mengunduh...', androidError: 'Tidak ditemukan app Android untuk proyek ini', androidViewReleases: 'Lihat semua rilis' },
      ja: { androidLoading: '„Éá„Éê„Ç§„Çπ„ÇíÊ§úÂá∫„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ‰∏≠...', androidError: '„Åì„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆAndroid„Ç¢„Éó„É™„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', androidViewReleases: '„Åô„Åπ„Å¶„ÅÆ„É™„É™„Éº„Çπ„ÇíË¶ã„Çã' },
      ko: { androidLoading: 'Í∏∞Í∏∞Î•º Í∞êÏßÄÌïòÍ≥† Îã§Ïö¥Î°úÎìú Ï§ë...', androidError: 'Ïù¥ ÌîÑÎ°úÏ†ùÌä∏Ïùò Android Ïï±ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§', androidViewReleases: 'Î™®Îì† Î¶¥Î¶¨Ïä§ Î≥¥Í∏∞' },
      mr: { androidLoading: '‡§§‡•Å‡§Æ‡§ö‡•á ‡§°‡§ø‡§µ‡•ç‡§π‡§æ‡§á‡§∏ ‡§ì‡§≥‡§ñ‡§§ ‡§Ü‡§π‡•á ‡§Ü‡§£‡§ø ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§§ ‡§Ü‡§π‡•á...', androidError: '‡§Ø‡§æ ‡§™‡•ç‡§∞‡§ï‡§≤‡•ç‡§™‡§æ‡§∏‡§æ‡§†‡•Ä ‡§ï‡•ã‡§£‡§§‡•á‡§π‡•Ä Android ‡§Ö‡•Ö‡§™ ‡§∏‡§æ‡§™‡§°‡§≤‡•á ‡§®‡§æ‡§π‡•Ä', androidViewReleases: '‡§∏‡§∞‡•ç‡§µ ‡§∞‡§ø‡§≤‡•Ä‡§ù ‡§™‡§π‡§æ' },
      ru: { androidLoading: '–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ –∑–∞–≥—Ä—É–∑–∫–∞...', androidError: 'Android-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', androidViewReleases: '–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ —Ä–µ–ª–∏–∑—ã' },
      sw: { androidLoading: 'Inatambua kifaa chako na kupakua...', androidError: 'Hakuna app ya Android iliyopatikana kwa mradi huu', androidViewReleases: 'Tazama matoleo yote' },
      ur: { androidLoading: 'ÿ¢Ÿæ ⁄©ÿß ÿ¢ŸÑ€Å Ÿæ€Å⁄ÜÿßŸÜÿß ÿ¨ÿß ÿ±€Åÿß €Å€í ÿßŸàÿ± ⁄àÿßÿ§ŸÜ ŸÑŸà⁄à €ÅŸà ÿ±€Åÿß €Å€í...', androidError: 'ÿßÿ≥ Ÿæÿ±Ÿàÿ¨€å⁄©Ÿπ ⁄©€í ŸÑ€å€í ⁄©Ÿàÿ¶€å Android ÿß€åŸæ ŸÜ€Å€å⁄∫ ŸÖŸÑ€å', androidViewReleases: 'ÿ™ŸÖÿßŸÖ ÿ±€åŸÑ€åÿ≤ÿ≤ ÿØ€å⁄©⁄æ€å⁄∫' },
      zh: { androidLoading: 'Ê≠£Âú®Ê£ÄÊµãÊÇ®ÁöÑËÆæÂ§áÂπ∂‰∏ãËΩΩ...', androidError: 'Êú™ÊâæÂà∞Ê≠§È°πÁõÆÁöÑ Android Â∫îÁî®', androidViewReleases: 'Êü•ÁúãÊâÄÊúâÁâàÊú¨' }
    };

    function detectLanguage() {
      const lang = navigator.language || navigator.userLanguage || 'en';
      const shortLang = lang.split('-')[0].toLowerCase();
      const supported = ['ar', 'bn', 'ca', 'de', 'en', 'es', 'fr', 'hi', 'id', 'ja', 'ko', 'mr', 'pt', 'ru', 'sw', 'ur', 'zh'];
      return supported.includes(shortLang) ? shortLang : 'en';
    }

    function applyTranslations(lang) {
      const t = translations[lang] || translations.en;
      const isRTL = ['ar', 'ur'].includes(lang);
      document.documentElement.dir = isRTL ? 'rtl' : 'ltr';
      document.documentElement.lang = lang === 'pt' ? 'pt-BR' : lang;
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (t[key]) el.textContent = t[key];
      });
    }

    function showError(detail, repo) {
      document.getElementById('loading').classList.add('hidden');
      const errorEl = document.getElementById('error');
      errorEl.classList.add('visible');
      document.getElementById('error-detail').textContent = detail || '';
      if (repo) {
        document.getElementById('releases-link').href = `https://github.com/${repo}/releases`;
      }
    }

    // Detect device architecture via User-Agent Client Hints API, fallback to arm64
    async function detectArch() {
      try {
        if (navigator.userAgentData) {
          const hints = await navigator.userAgentData.getHighEntropyValues(['architecture']);
          if (hints.architecture) return hints.architecture;
        }
      } catch (e) {
        // API unavailable or permission denied
      }
      return 'arm64';
    }

    // Find the best matching APK from release assets
    function findApk(assets, repo, arch) {
      const repoName = repo.split('/')[1];
      const apks = assets.filter(a => a.name.endsWith('.apk'));
      if (!apks.length) return null;

      // Priority 1: exact match {repo}-android-{arch}.apk
      const exact = apks.find(a => a.name === `${repoName}-android-${arch}.apk`);
      if (exact) return exact;

      // Priority 2: partial match *android*{arch}*.apk
      const archLower = arch.toLowerCase();
      const partialArch = apks.find(a => {
        const name = a.name.toLowerCase();
        return name.includes('android') && name.includes(archLower);
      });
      if (partialArch) return partialArch;

      // Priority 3: any Android APK *android*.apk
      const anyAndroid = apks.find(a => a.name.toLowerCase().includes('android'));
      if (anyAndroid) return anyAndroid;

      // Priority 4: any APK at all
      return apks[0];
    }

    async function main() {
      const lang = detectLanguage();
      applyTranslations(lang);

      // Read ?gh= parameter
      const params = new URLSearchParams(window.location.search);
      const repo = params.get('gh');

      if (!repo || !repo.match(/^[a-zA-Z0-9_.-]+\/[a-zA-Z0-9_.-]+$/)) {
        showError('Invalid or missing ?gh=user/repo parameter', null);
        return;
      }

      // Check if the repo has its own android.html (full override)
      try {
        const checkUrl = `https://raw.githubusercontent.com/${repo}/refs/heads/main/android.html`;
        const head = await fetch(checkUrl, { method: 'HEAD' });
        if (head.ok) {
          window.location.href = checkUrl;
          return;
        }
      } catch (e) {
        // 404 or network error, proceed with default flow
      }

      // Check if the repo has an android.txt (custom URL redirect)
      try {
        const txtUrl = `https://raw.githubusercontent.com/${repo}/refs/heads/main/android.txt`;
        const txtRes = await fetch(txtUrl);
        if (txtRes.ok) {
          const url = (await txtRes.text()).trim().split('\n')[0].trim();
          if (url) {
            window.location.href = url;
            return;
          }
        }
      } catch (e) {
        // 404 or network error, proceed with default flow
      }

      // Detect architecture and fetch release in parallel
      const [arch, releaseRes] = await Promise.all([
        detectArch(),
        fetch(`https://api.github.com/repos/${repo}/releases/latest`).catch(() => null)
      ]);

      // No releases or API error ‚Äî redirect to repo home
      if (!releaseRes || !releaseRes.ok) {
        window.location.href = `https://github.com/${repo}`;
        return;
      }

      const release = await releaseRes.json();
      const apk = findApk(release.assets || [], repo, arch);

      if (apk) {
        window.location.href = apk.browser_download_url;
      } else {
        // No APK in releases ‚Äî redirect to repo home
        window.location.href = `https://github.com/${repo}`;
      }
    }

    main();
  </script>
</body>
</html>
